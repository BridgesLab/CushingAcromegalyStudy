---
title: "Weight Analysis of Dexamethasone Treated C57BL/6J Mice"
author: "Innocence Harvey and Dave Bridges"
date: "February 23, 2015"
output:
  html_document:
    keep_md: yes
  pdf_document:
    keep_tex: yes
---

```{r global_options, include=FALSE}
library(knitr)
#figures makde will go to directory called figures, will make them as both png and pdf files 
opts_chunk$set(fig.path='figures/',
               echo=FALSE, warning=FALSE, message=FALSE,dev=c('png','pdf'))
options(scipen = 2, digits = 3)
# set echo and message to TRUE if you want to display code blocks and code output respectively

knitr::knit_hooks$set(inline = function(x) {
  knitr:::format_sci(x, 'md')
})


superpose.eb <- function (x, y, ebl, ebu = ebl, length = 0.08, ...)
  arrows(x, y + ebu, x, y - ebl, angle = 90, code = 3,
  length = length, ...)

  
se <- function(x) sd(x, na.rm=T)/sqrt(length(x))

#load these packages, nearly always needed
library(tidyr)
library(dplyr)
library(car)
```

# Data Entry
This was from combined weights over several measurements of C57BL/6J Mice on treated with dexamethasone.  Some animals may appear multiple times in this analysis.  Data is downloaded in csv format from the mousedb website.  This includes only fed weights.  These mice were treated with 10 mg/kg/day starting at 70 days of age.

```{r data-entry}
raw_data_file <- "../../data/raw/Body Composition Data.csv"

#uncomment to update
data.dex <- read.csv(raw_data_file, row.names='X')
data.dex$Treatment <- relevel(data.dex$Treatment, ref='Water')
data.dex$age.from.start <- data.dex$age - 70
#reorder by age
data.dex <- data.dex[order(data.dex$age),]
#removed sick mouse 425
data.dex <- subset(data.dex, animal.MouseID != 425)
```

Data was downloaded from MouseDB then aand the data is saved as `r raw_data_file`.  These data  was most recently updated on `r date()`.

# Body Weights

```{r weights-scatterplot}
weight.data <- subset(data.dex, assay.assay=="Body Weight")
weight.data$Weight <- as.numeric(as.character(weight.data$values))/1000 #in g

with(weight.data, plot(age, Weight,
                       col=Treatment,
                       ylab="Body Weight (g)",
                       xlab='Age (days)',
                        las=1, pch=19))

se <- function(x) sd(x)/sqrt(length(x))
library(dplyr)
shapiro.p <- function(x) shapiro.test(x)$p.value

weight.summary <- weight.data %>%
    group_by(age, age.from.start, Treatment) %>%
    summarize(
      average=mean(Weight), 
      sd=sd(Weight), 
      se=se(Weight), 
      n=length(Weight),
      shapiro.p=shapiro.p(Weight))

with(subset(weight.summary, Treatment=='Water'), lines(age, average, col=palette()[1]))
with(subset(weight.summary, Treatment=='Dexamethasone'), lines(age, average, col=palette()[2]))

yvals <- with(weight.summary, c(min(average-sd), max(average+sd)))
plot <- with(subset(weight.summary, Treatment=='Water'), plot(age.from.start,average, 
                                                      type="l", ylim=yvals, xlim=c(0,77),
                                                      las=1, ylab="Body Weight (g)", xlab="Dexamethasone Treatment (d)",
                                                      col=palette()[1]))
with(subset(weight.summary, Treatment=='Dexamethasone'), lines(age.from.start,average, col=palette()[2]))

superpose.eb <- 
 function (x, y, ebl, ebu = ebl, length = 0.08, ...) 
 arrows(x, y + ebu, x, y - ebl, angle = 90, code = 3, 
 length = length, ...)

with(subset(weight.summary, Treatment=="Water"), superpose.eb(age.from.start,average,se,col=palette()[1]))
with(subset(weight.summary, Treatment=="Dexamethasone"), superpose.eb(age.from.start,average,se,col=palette()[2]))
```

## Body Weight Statistics

```{r body-weight-statistics}
library(ggplot2)
ggplot(data = subset(weight.data, age>69),
       aes(y=Weight,
       x=age.from.start,
       col=Treatment)) +
  geom_smooth()

#repeated measures model
library(lme4)
weight.lme <- lmer(Weight ~ age.from.start + Treatment + age.from.start:Treatment + (1|animal.MouseID), data=subset(weight.data, age>69))
weight.lme.null <- lmer(Weight ~ age.from.start + Treatment + (1|animal.MouseID), data=subset(weight.data, age>69))
```

```{r body-weight-endpoint}
kable(weight.summary %>% filter(age==147), caption="Summary statistics for body weight at endpoint")
```

At the end of the study, there was a `r (subset(weight.summary, age==147)$average[1]-subset(weight.summary, age==147)$average[2])/subset(weight.summary, age==147)$average[1]*100` % decrease in body weight **(p=`r t.test(Weight~Treatment, data=weight.data %>% filter(age==147), var.equal=T)$p.value`)** from a Student's *t*-test.  A levene's test has a p-value of `r leveneTest(Weight~Treatment, data=weight.data %>% filter(age==147))$"Pr(>F)"[1]`.

Based on a linear mixed effects model, the p-value for an effect of Dexamethasone on the rate of change in body weight was `r anova(weight.lme, weight.lme.null)$"Pr(>Chisq)"[2]` (Chi-squared=`r anova(weight.lme, weight.lme.null)$"Chisq"[2]`) with an increase of `r fixef(weight.lme)['age.from.start:TreatmentDexamethasone']*7`\% per week.  To test for normality in this model we did a Shapiro-Wilk test and found that the did not meet this assumption `r shapiro.test(residuals(weight.lme))$p.value`.

# Lean Mass

```{r lean-mass-scatterplot}
lean.mass.data <- subset(data.dex, assay.assay=="Lean Mass")
lean.mass.data$Weight <- as.numeric(as.character(lean.mass.data$values))/1000 #in g

with(lean.mass.data, plot(age, Weight,
                       col=Treatment,
                      ylab="Lean Mass (g)",
                       xlab='Age (days)',
                        las=1, pch=19))


lean.mass.summary <- lean.mass.data %>%
    group_by(age, age.from.start, Treatment) %>%
    summarize(
      average=mean(Weight), 
      sd=sd(Weight), 
      se=se(Weight), 
      n=length(Weight),
      shapiro.p=shapiro.p(Weight))

with(subset(lean.mass.summary, Treatment=='Water'), lines(age, average, col=palette()[1]))
with(subset(lean.mass.summary, Treatment=='Dexamethasone'), lines(age, average, col=palette()[2]))

yvals <- with(lean.mass.summary, c(min(average-sd), max(average+sd)))
plot <- with(subset(lean.mass.summary, Treatment=='Water'), plot(age.from.start,average, 
                                                      type="l", ylim=yvals, xlim=c(0,77),
                                                      las=1, ylab="Lean Mass (g)", xlab="Dexamethasone Treatment (d)",
                                                      col=palette()[1]))
with(subset(lean.mass.summary, Treatment=='Dexamethasone'), lines(age.from.start,average, col=palette()[2]))

with(subset(lean.mass.summary, Treatment=="Water"), superpose.eb(age.from.start,average,se,col=palette()[1]))
with(subset(lean.mass.summary, Treatment=="Dexamethasone"), superpose.eb(age.from.start,average,se,col=palette()[2]))
```

```{r lean-mass-endpoint}
kable(lean.mass.summary %>% filter(age==147), caption="Summary statistics for lean mass at endpoint")
```

At the end of the study, there was a `r (subset(lean.mass.summary, age==147)$average[1]-subset(lean.mass.summary, age==147)$average[2])/subset(lean.mass.summary, age==147)$average[1]*100` % decrease in fat-free mass **(p=`r t.test(Weight~Treatment, data=lean.mass.data %>% filter(age==147), var.equal=T)$p.value`)** from a Student's *t*-test.  A levene's test has a p-value of `r leveneTest(Weight~Treatment, data=lean.mass.data %>% filter(age==147))$"Pr(>F)"[1]`.

# Fat Mass

```{r fat-mass-scatterplot}
fat.mass.data <- subset(data.dex, assay.assay=="Total Fat Mass")
fat.mass.data$Weight <- as.numeric(as.character(fat.mass.data$values))/1000 #in g

with(fat.mass.data, plot(age, Weight,
                       col=Treatment,
                       ylab="Fat Mass (g)",
                       xlab='Age (days)',
                        las=1, pch=19))

fat.mass.summary <- fat.mass.data %>%
    group_by(age, age.from.start, Treatment) %>%
    summarize(
      average=mean(Weight), 
      sd=sd(Weight), 
      se=se(Weight), 
      n=length(Weight),
      shapiro.p=shapiro.p(Weight))

with(subset(fat.mass.summary, Treatment=='Water'), lines(age, average, col=palette()[1]))
with(subset(fat.mass.summary, Treatment=='Dexamethasone'), lines(age, average, col=palette()[2]))

yvals <- with(fat.mass.summary, c(min(average-sd), max(average+sd)))
plot <- with(subset(fat.mass.summary, Treatment=='Water'), plot(age.from.start,average, 
                                                      type="l", ylim=yvals, xlim=c(0,77),
                                                      las=1, ylab="Fat Mass (g)", xlab="Dexamethasone Treatment (d)",
                                                      col=palette()[1]))
with(subset(fat.mass.summary, Treatment=='Dexamethasone'), lines(age.from.start,average, col=palette()[2]))

with(subset(fat.mass.summary, Treatment=="Water"), superpose.eb(age.from.start,average,se,col=palette()[1]))
with(subset(fat.mass.summary, Treatment=="Dexamethasone"), superpose.eb(age.from.start,average,se,col=palette()[2]))
```

```{r fat-mass-endpoint}
kable(fat.mass.summary %>% filter(age==147), caption="Summary statistics for fat mass at endpoint")
```

At the end of the study, there was a `r (subset(fat.mass.summary, age==147)$average[2]-subset(fat.mass.summary, age==147)$average[1])/subset(fat.mass.summary, age==147)$average[1]*100` % increase in fat mass **(p=`r t.test(Weight~Treatment, data=fat.mass.data %>% filter(age==147), var.equal=T)$p.value`)** from a Student's *t*-test.  A levene's test has a p-value of `r leveneTest(Weight~Treatment, data=fat.mass.data %>% filter(age==147))$"Pr(>F)"[1]`


```{r pct-fat-mass-scatterplot}
pct.fat.mass.data <- merge(
  weight.data[,c('animal.MouseID','Weight','age','age.from.start','Treatment')], 
  fat.mass.data[,c('animal.MouseID','Weight','age','age.from.start','Treatment')],
  by=c('age','age.from.start','animal.MouseID','Treatment'))
pct.fat.mass.data$Pct.Fat.Mass <- pct.fat.mass.data$Weight.y/pct.fat.mass.data$Weight.x*100

with(pct.fat.mass.data, plot(age, Pct.Fat.Mass,
                       col=Treatment,
                       ylab="Percent Fat Mass",
                       xlab='Age (days)',
                        las=1, pch=19))

pct.fat.mass.summary <- pct.fat.mass.data %>%
    group_by(age, age.from.start, Treatment) %>%
    summarize(
      average=mean(Pct.Fat.Mass), 
      sd=sd(Pct.Fat.Mass), 
      se=se(Pct.Fat.Mass), 
      n=length(Pct.Fat.Mass),
      shapiro.p = shapiro.p(Pct.Fat.Mass))
pct.fat.mass.summary <- pct.fat.mass.summary[order(pct.fat.mass.summary$age),]

with(subset(pct.fat.mass.summary, Treatment=='Water'), lines(age, average, col=palette()[1]))
with(subset(pct.fat.mass.summary, Treatment=='Dexamethasone'), lines(age, average, col=palette()[2]))

yvals <- with(pct.fat.mass.summary, c(min(average-sd), max(average+sd)))
plot <- with(subset(pct.fat.mass.summary, Treatment=='Water'), plot(age.from.start,average, 
                                                      type="l", ylim=yvals, xlim=c(0,77),
                                                      las=1, ylab="Percent Fat Mass", xlab="Dexamethasone Treatment (d)",
                                                      col=palette()[1]))
with(subset(pct.fat.mass.summary, Treatment=='Dexamethasone'), lines(age.from.start,average, col=palette()[2]))

with(subset(pct.fat.mass.summary, Treatment=="Water"), superpose.eb(age.from.start,average,se,col=palette()[1]))
with(subset(pct.fat.mass.summary, Treatment=="Dexamethasone"), superpose.eb(age.from.start,average,se,col=palette()[2]))
```

```{r pct-fat-mass-scatterplot-smooth}
with(pct.fat.mass.data, plot(age.from.start, Pct.Fat.Mass,
                       col=Treatment,
                       ylab="Percent Fat Mass",
                       xlab='Dexamethasone Treatment (days)',
                       xlim=c(0,max(age)-70),
                        las=1, pch=19))

fat.mass.lme <- lmer(Pct.Fat.Mass ~ age.from.start + Treatment + age.from.start:Treatment + (1|animal.MouseID), data=subset(pct.fat.mass.data, age>69))
fat.mass.lme.null <- lmer(Pct.Fat.Mass ~ age.from.start + Treatment + (1|animal.MouseID), data=subset(pct.fat.mass.data, age>69))

abline(a=fixef(fat.mass.lme)['(Intercept)'], b=fixef(fat.mass.lme)['age.from.start'], col=palette()[1])
abline(a=fixef(fat.mass.lme)['(Intercept)'], b=fixef(fat.mass.lme)['age.from.start']+fixef(fat.mass.lme)['age.from.start:TreatmentDexamethasone'], col=palette()[2])

legend('topleft', levels(data.dex$Treatment), col=palette()[1:2], bty='n', pch=19, lty=1)
```

Based on a linear mixed effects model, the p-value for an effect of Dexamethasone on the rate of change in percent fat mass was `r anova(fat.mass.lme, fat.mass.lme.null)$"Pr(>Chisq)"[2]` (Chi-squared=`r anova(fat.mass.lme, fat.mass.lme.null)$"Chisq"[2]`) with an increase of `r fixef(fat.mass.lme)['age.from.start:TreatmentDexamethasone']*7`\% per week.  To test for normality in this model we did a Shapiro-Wilk test and found that the did not meet this assumption `r shapiro.test(residuals(fat.mass.lme))$p.value`.  

```{r pct-fat-mass-endpoint}
kable(pct.fat.mass.summary %>% filter(age==147), caption="Summary statistics for percent fat mass at endpoint")

```

At the end of the study, there was a `r (subset(pct.fat.mass.summary, age==147)$average[2]-subset(pct.fat.mass.summary, age==147)$average[1])/subset(pct.fat.mass.summary, age==147)$average[1]*100` % increase in fat mass **(p=`r t.test(Pct.Fat.Mass~Treatment, data=pct.fat.mass.data %>% filter(age==147), var.equal=T)$p.value`)** from a Student's *t*-test.  A levene's test has a p-value of `r leveneTest(Pct.Fat.Mass~Treatment, data=pct.fat.mass.data %>% filter(age==147))$"Pr(>F)"[1]`

# Session Information
```{r sessionInfo}
sessionInfo()
```