---
title: "ITT for Dexamethasone Treated HFD-Fed Mice"
author: "Innocence Harvey, Erin Stephenson and Dave Bridges"
date: "February 11, 2015"
output:
html_document:
    fig_caption: yes
    keep_md: yes
---

```{r global_options, include=FALSE}
library(knitr)
opts_chunk$set(fig.path='figures/',
               echo=FALSE, warning=FALSE, message=FALSE,dev=c('png','pdf'))

options(scipen = 2, digits = 5)


knitr::knit_hooks$set(inline = function(x) {
  knitr:::format_sci(x, 'md')
})

se <- function(x) sd(x, na.rm=T)/sqrt(length(x))

superpose.eb <- function (x, y, ebl, ebu = ebl, length = 0.08, ...)
arrows(x, y + ebu, x, y - ebl, angle = 90, code = 3,
length = length, ...)

color.scheme <- c('black','red')
```

```{r data-entry}
hfd.filename <- '../../data/raw/HFD ITT Data.csv'
hfd.itt <- read.csv(hfd.filename)
ncd.filename <- '../../data/raw/NCD ITT Data.csv'
ncd.itt <- read.csv(ncd.filename)

itt.glucose <- rbind(ncd.itt,hfd.itt)
itt.glucose$AUC <- rowSums(itt.glucose[,4:12])
```

These data were found in the files `r hfd.filename` and `r ncd.filename`.  This document can be found in `r getwd()`.  This scipt was mst recently run on `r date()`.

```{r analysis}

library(dplyr)
itt.summary.barplots <-
  itt.glucose %>%
  group_by(Treatment,Diet) %>%
  summarize(FG.mean = mean(t0),
            FG.se = se(t0),
            AUC.mean = mean(AUC, na.rm=T),
            AUC.se = se(AUC))

mean.na <- function(x) mean(x, na.rm=T)

itt.summary.lineplots <-
  itt.glucose %>%
  group_by(Treatment,Diet) %>%
  summarize_each(funs(mean.na,se), starts_with("t"))
```

```{r itt-lineplot}
ymax <- max(itt.summary.lineplots[,3:11])
times <- c(0,15,30,45,60,75,90,105,120)
plot(times, itt.summary.lineplots[3,3:11], 
     type="l", ylim=c(0,400), las=1,
     ylab="Blood Glucose (mg/dL)",
     xlab="Insulin (min)")
lines(times, itt.summary.lineplots[1,3:11], col=color.scheme[2])
lines(times, itt.summary.lineplots[4,3:11], col=color.scheme[1], lty=2)
lines(times, itt.summary.lineplots[2,3:11], col=color.scheme[2], lty=2)
legend("right", c("NCD - Control", "NCD - Dexamethasone", "HFD - Control", "HFD - Dexamethasone"),
       col=c(color.scheme[1],color.scheme[2],color.scheme[1],color.scheme[2]),
       lty=c(1,1,2,2),
       bty="n")

superpose.eb <- function (x, y, ebl, ebu = ebl, length = 0.08, ...)
arrows(x, y + ebu, x, y - ebl, angle = 90, code = 3,
length = length, ...)

#add error bars for water
superpose.eb(times,
             as.numeric(itt.summary.lineplots[3,3:11]),
             as.numeric(itt.summary.lineplots[3,12:20]))
superpose.eb(times,
             as.numeric(itt.summary.lineplots[1,3:11]),
             as.numeric(itt.summary.lineplots[1,12:20]),
             col=color.scheme[2])
superpose.eb(times,
             as.numeric(itt.summary.lineplots[4,3:11]),
             as.numeric(itt.summary.lineplots[4,12:20]))
superpose.eb(times,
             as.numeric(itt.summary.lineplots[2,3:11]),
             as.numeric(itt.summary.lineplots[2,12:20]),
             col=color.scheme[2])
     
```

## Fasting Blood Glucose

```{r itt-fasting-glucose}
library(tidyr)
itt.summary.barplots$Treatment <- relevel(itt.summary.barplots$Treatment, ref="Water")
itt.summary.barplots$Diet <- relevel(itt.summary.barplots$Diet, ref="NCD")

barplot.data <- 
  itt.summary.barplots %>%
  select(Treatment,Diet, FG.mean) %>%
  spread(Diet, FG.mean)

barplot.data.se <- 
  itt.summary.barplots %>%
  select(Treatment,Diet, FG.se) %>%
  spread(Diet, FG.se)


ymax <- max(itt.summary.barplots$FG.mean + itt.summary.barplots$FG.se)
plot <- barplot(as.matrix(barplot.data[2:3]),
                beside=T, las=1,
                ylab=("Fasting Glucose (mg/dL)"),
                col=c(color.scheme[1],color.scheme[2]),
                ylim=c(0,ymax))

superpose.eb(plot,
             as.matrix(barplot.data[2:3]),
             as.matrix(barplot.data.se[2:3]))

legend("topleft", levels(barplot.data$Treatment), fill=color.scheme, bty="n")
```

### Fasting Glucose Statistics

Analysed these data by 2-way ANOVA with an interaction

```{r fasting-glucose-statistics}
fg.aov <- aov(t0 ~ Treatment + Diet + Treatment:Diet, data=itt.glucose)
kable(summary(fg.aov)[[1]], caption="2 Way ANOVA for Fasting Glucose")
```

The residuals from this ANOVA can **not** be assumed to be normally distributed as they fail a Shapiro-Wilk test (p=`r shapiro.test(residuals(fg.aov))$p.value`).

## Area Under Curve During ITT

```{r itt-auc-barplot}
barplot.data <- 
  itt.summary.barplots %>%
  select(Treatment,Diet, AUC.mean) %>%
  spread(Diet, AUC.mean)

barplot.data.se <- 
  itt.summary.barplots %>%
  select(Treatment,Diet, AUC.se) %>%
  spread(Diet, AUC.se)


ymax <- max(itt.summary.barplots$AUC.mean + itt.summary.barplots$AUC.se)
plot <- barplot(as.matrix(barplot.data[2:3]),
                beside=T, las=1,
                ylab=("Area Under Curve of ITT"),
                col=c(color.scheme[1],color.scheme[2]),
                ylim=c(0,ymax))

superpose.eb(plot,
             as.matrix(barplot.data[2:3]),
             as.matrix(barplot.data.se[2:3]))

legend("topleft", levels(barplot.data$Treatment), fill=color.scheme, bty="n")
```

### AUC Statistics

Analysed these data by 2-way ANOVA with an interaction

```{r auc-statistics}
auc.aov <- aov(AUC ~ Treatment + Diet + Treatment:Diet, data=itt.glucose)
kable(summary(auc.aov)[[1]], caption="2 Way ANOVA for Area Under Curve of ITT")
```

The residuals from this ANOVA can **not** be assumed to be normally distributed as they fail a Shapiro-Wilk test (p=`r shapiro.test(residuals(auc.aov))$p.value`).


# Session Information

```{r session-info}
sessionInfo()
```
